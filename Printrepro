<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusPrint</title>
    
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            console.error(error);
            // Alert removed for cleaner UX, check console for errors
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
    
    <div id="root" class="flex h-screen items-center justify-center text-gray-500">
        Loading CampusPrint...
    </div>

    <script type="text/babel">
        // --- ICONS ---
        const IconPrinter = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>;
        const IconFileText = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>;
        const IconUser = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const IconBriefcase = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>;
        const IconLogOut = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>;
        const IconUpload = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>;
        const IconLeaf = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.77 10-10 10Z"></path><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"></path></svg>;
        const IconClock = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const IconCheckCircle = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const IconAlertCircle = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDfRweREGY-F7IpzGmPq0PNr7sPKO_iDDI",
            authDomain: "campusprint-70eb3.firebaseapp.com",
            projectId: "campusprint-70eb3",
            storageBucket: "campusprint-70eb3.firebasestorage.app",
            messagingSenderId: "764909713650",
            appId: "1:764909713650:web:702ed7b3e8d0f964a4786b",
            measurementId: "G-1436F3ZDTY"
        };

        // Initialize Firebase
        let app, auth, db;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        const { useState, useEffect } = React;

        // --- COMPONENTS ---

        const Header = ({ user, role, handleLogout }) => (
            <nav className="bg-blue-600 text-white p-4 shadow-lg sticky top-0 z-50">
                <div className="container mx-auto flex justify-between items-center">
                    <div className="flex items-center space-x-2">
                        <IconPrinter className="h-6 w-6" />
                        <span className="text-xl font-bold">CampusPrint</span>
                    </div>
                    {user && (
                        <div className="flex items-center space-x-4">
                            <div className="hidden md:flex flex-col text-right text-xs">
                                <span className="font-semibold">{user.isAnonymous ? 'Guest User' : user.displayName || 'Student'}</span>
                                <span className="opacity-75">{role === 'student' ? 'Student View' : 'Shop Admin'}</span>
                            </div>
                            <button onClick={handleLogout} className="p-2 bg-blue-700 rounded-full hover:bg-blue-800 transition shadow-inner" title="Sign Out">
                                <IconLogOut className="h-4 w-4" />
                            </button>
                        </div>
                    )}
                </div>
            </nav>
        );

        const Login = ({ setRole }) => {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (selectedRole) => {
                setLoading(true);
                setError('');
                if (!auth) {
                    setError("Firebase not configured.");
                    setLoading(false);
                    return;
                }
                try {
                    await auth.signInAnonymously();
                    setRole(selectedRole);
                } catch (err) {
                    console.error("Login error:", err);
                    if (err.code === 'auth/configuration-not-found') {
                        setError("Authentication Disabled. Go to Firebase Console > Authentication > Sign-in method > Enable 'Anonymous' provider.");
                    } else if (err.code === 'auth/api-key-not-valid') {
                        setError("API Key Invalid. Check your firebaseConfig keys in the code.");
                    } else {
                        // FIX 1: Added backticks around template literal
                        setError(`Authentication failed: ${err.message}`);
                    }
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
                        <div className="mb-6 flex justify-center text-blue-600">
                            <IconPrinter className="h-16 w-16" />
                        </div>
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">CampusPrint</h1>
                        <p className="text-gray-500 mb-8">Skip the line. Print online.</p>
                        {error && (
                            <div className="mb-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg flex flex-col items-center justify-center border border-red-200">
                                <div className="flex items-center font-bold mb-1">
                                    <IconAlertCircle className="w-4 h-4 mr-2" />
                                    Error
                                </div>
                                <div className="text-center">{error}</div>
                            </div>
                        )}
                        <div className="space-y-4">
                            <button onClick={() => handleLogin('student')} disabled={loading} className="w-full flex items-center justify-center space-x-3 bg-white border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 text-gray-700 font-semibold py-3 px-4 rounded-xl transition duration-200 group">
                                {loading ? <div className="w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div> : <IconUser className="group-hover:text-blue-600 text-gray-400" />}
                                <span>Login as Student</span>
                            </button>
                            <button onClick={() => handleLogin('admin')} disabled={loading} className="w-full flex items-center justify-center space-x-3 bg-white border-2 border-gray-200 hover:border-purple-500 hover:bg-purple-50 text-gray-700 font-semibold py-3 px-4 rounded-xl transition duration-200 group">
                                {loading ? <div className="w-5 h-5 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></div> : <IconBriefcase className="group-hover:text-purple-600 text-gray-400" />}
                                <span>Login as Shop Owner</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const StudentDashboard = ({ user }) => {
            const [file, setFile] = useState(null);
            const [copies, setCopies] = useState(1);
            const [color, setColor] = useState('bw');
            const [sides, setSides] = useState('single');
            const [submitting, setSubmitting] = useState(false);
            const [activeJobs, setActiveJobs] = useState([]);
            const [notification, setNotification] = useState(null);

            useEffect(() => {
                if (!user || !db) return;
                
                const unsubscribe = db.collection('print_jobs')
                    .where('userId', '==', user.uid)
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        const jobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setActiveJobs(jobs);
                    }, (error) => {
                        console.log("Index might be missing, trying simple fetch", error);
                        // Fallback logic
                        db.collection('print_jobs').where('userId', '==', user.uid).onSnapshot(snap => {
                            const jobs = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                            jobs.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                            setActiveJobs(jobs);
                        });
                    });
                return () => unsubscribe();
            }, [user]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!file && !activeJobs.length) return;
                setSubmitting(true);
                try {
                    await db.collection('print_jobs').add({
                        userId: user.uid,
                        userName: user.displayName || 'Student',
                        fileName: file ? file.name : "Untitled Document.pdf",
                        fileUrl: "https://via.placeholder.com/150", 
                        copies,
                        color,
                        sides,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        cost: calculateCost(copies, color, sides)
                    });
                    setFile(null);
                    setNotification({ type: 'success', message: 'Print job sent successfully!' });
                    setTimeout(() => setNotification(null), 3000);
                } catch (error) {
                    console.error("Error submitting:", error);
                    setNotification({ type: 'error', message: 'Failed to submit. Did you enable Firestore in Test Mode?' });
                } finally {
                    setSubmitting(false);
                }
            };

            const calculateCost = (c, col, s) => {
                const price = col === 'color' ? 10 : 2;
                const sheets = s === 'double' ? 5 : 10; // This math seems unique, but keeping logic as is
                return c * price * sheets;
            };

            return (
                <div className="container mx-auto p-4 max-w-4xl">
                    {notification && (
                        // FIX 2: Added backticks around template literal
                        <div className={`mb-4 p-4 rounded-xl flex items-center animate-pulse ${notification.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                            {notification.type === 'success' ? <IconCheckCircle className="w-5 h-5 mr-2" /> : <IconAlertCircle className="w-5 h-5 mr-2" />}
                            {notification.message}
                        </div>
                    )}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h2 className="text-xl font-bold mb-4 flex items-center text-gray-800">
                                <IconUpload className="mr-2 h-5 w-5 text-blue-500" /> New Print Job
                            </h2>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:bg-gray-50 transition cursor-pointer relative group">
                                    <input type="file" accept=".pdf,.doc,.docx" onChange={(e) => setFile(e.target.files[0])} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                    <div className="flex flex-col items-center group-hover:scale-105 transition-transform">
                                        {/* FIX 3: Added backticks */}
                                        <IconFileText className={`h-10 w-10 mb-2 ${file ? 'text-green-500' : 'text-gray-400'}`} />
                                        <span className="text-sm font-medium text-gray-600">{file ? file.name : "Click to upload PDF/Doc"}</span>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Color</label>
                                        <select className="w-full p-2 bg-gray-50 border rounded-lg text-sm" value={color} onChange={(e) => setColor(e.target.value)}>
                                            <option value="bw">Black & White (₹2/pg)</option>
                                            <option value="color">Color (₹10/pg)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Copies</label>
                                        <input type="number" min="1" max="50" className="w-full p-2 bg-gray-50 border rounded-lg text-sm" value={copies} onChange={(e) => setCopies(parseInt(e.target.value) || 1)} />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Sides</label>
                                    <div className="flex space-x-2">
                                        {/* FIX 4: Added backticks */}
                                        <button type="button" onClick={() => setSides('single')} className={`flex-1 py-2 text-sm rounded-lg border transition ${sides === 'single' ? 'bg-blue-50 border-blue-500 text-blue-700 font-medium' : 'border-gray-200 text-gray-600'}`}>Single</button>
                                        {/* FIX 5: Added backticks */}
                                        <button type="button" onClick={() => setSides('double')} className={`flex-1 py-2 text-sm rounded-lg border flex items-center justify-center transition ${sides === 'double' ? 'bg-green-50 border-green-500 text-green-700 font-medium' : 'border-gray-200 text-gray-600'}`}><IconLeaf className="w-3 h-3 mr-1" /> Double</button>
                                    </div>
                                </div>
                                {/* FIX 6: Added backticks */}
                                <button type="submit" disabled={submitting || (!file && activeJobs.length === 0)} className={`w-full py-3 rounded-xl text-white font-bold shadow-md transition transform active:scale-95 ${submitting ? 'bg-gray-400' : 'bg-blue-600 hover:bg-blue-700'}`}>{submitting ? 'Uploading...' : 'Send to Printer'}</button>
                            </form>
                        </div>
                        <div>
                            <h2 className="text-xl font-bold mb-4 text-gray-800 flex items-center"><IconClock className="mr-2 h-5 w-5 text-orange-500" /> Your Queue</h2>
                            <div className="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                                {activeJobs.length === 0 ? <div className="text-center py-10 bg-gray-50 rounded-xl border border-gray-100 text-gray-400">No active print jobs</div> : activeJobs.map(job => (
                                    <div key={job.id} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center hover:shadow-md transition">
                                        <div className="flex items-start space-x-3">
                                            <div className="p-2 bg-gray-100 rounded-lg"><IconFileText className="w-5 h-5 text-gray-500" /></div>
                                            <div>
                                                <h3 className="font-semibold text-gray-800 text-sm">{job.fileName}</h3>
                                                <p className="text-xs text-gray-500 mt-1">{job.copies} copy • {job.color} • {job.sides}</p>
                                            </div>
                                        </div>
                                        <div className="flex flex-col items-end">
                                            {/* FIX 7: Added backticks */}
                                            <span className={`px-2 py-1 rounded-full text-[10px] font-bold uppercase ${job.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : ''} ${job.status === 'printing' ? 'bg-blue-100 text-blue-700' : ''} ${job.status === 'completed' ? 'bg-green-100 text-green-700' : ''}`}>{job.status}</span>
                                            <span className="text-xs text-gray-400 mt-1 font-mono">₹{job.cost}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const OwnerDashboard = () => {
            const [jobs, setJobs] = useState([]);
            useEffect(() => {
                if (!db) return;
                const unsubscribe = db.collection('print_jobs')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        const allJobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setJobs(allJobs);
                    }, (error) => {
                         console.log("Index missing fallback", error);
                         // Fallback sort
                         db.collection('print_jobs').onSnapshot(snap => {
                             const jobs = snap.docs.map(d=>({id:d.id, ...d.data()}));
                             jobs.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                             setJobs(jobs);
                         });
                    });
                return () => unsubscribe();
            }, []);

            const updateStatus = async (jobId, newStatus) => {
                try {
                    await db.collection('print_jobs').doc(jobId).update({ status: newStatus });
                } catch (err) { console.error("Failed to update", err); }
            };

            return (
                <div className="container mx-auto p-4">
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-end mb-6 gap-4">
                        <div><h2 className="text-2xl font-bold text-gray-800">Print Queue</h2><p className="text-gray-500">Manage incoming requests</p></div>
                        <div className="bg-blue-50 text-blue-700 px-4 py-2 rounded-lg font-bold border border-blue-100 flex items-center"><IconClock className="w-4 h-4 mr-2" />{jobs.filter(j => j.status !== 'completed').length} Pending</div>
                    </div>
                    <div className="bg-white shadow-sm rounded-xl overflow-hidden border border-gray-200">
                        <div className="overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th className="p-4 text-xs font-bold text-gray-500 uppercase">Student</th>
                                        <th className="p-4 text-xs font-bold text-gray-500 uppercase">File</th>
                                        <th className="p-4 text-xs font-bold text-gray-500 uppercase">Details</th>
                                        <th className="p-4 text-xs font-bold text-gray-500 uppercase">Action</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {jobs.map(job => (
                                        <tr key={job.id} className="hover:bg-gray-50 transition-colors">
                                            <td className="p-4"><div className="font-semibold text-gray-700">{job.userName}</div></td>
                                            <td className="p-4"><div className="flex items-center text-blue-600"><IconFileText className="w-4 h-4 mr-1" />{job.fileName}</div></td>
                                            <td className="p-4 text-sm text-gray-600">
                                                <span className="bg-gray-100 px-2 py-1 rounded text-xs mr-1">{job.copies}x</span>
                                                <span className="bg-gray-100 px-2 py-1 rounded text-xs">{job.color}</span>
                                            </td>
                                            <td className="p-4">
                                                <div className="flex space-x-2">
                                                    {job.status === 'pending' && <button onClick={() => updateStatus(job.id, 'printing')} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-xs font-medium">Start</button>}
                                                    {job.status === 'printing' && <button onClick={() => updateStatus(job.id, 'completed')} className="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-xs font-medium">Finish</button>}
                                                    {job.status === 'completed' && <span className="text-emerald-600 text-sm font-bold flex items-center"><IconCheckCircle className="w-4 h-4 mr-1"/>Done</span>}
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState(null);
            const [initializing, setInitializing] = useState(true);

            useEffect(() => {
                if(!auth) { setInitializing(false); return; }
                const unsubscribe = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (!u) setRole(null);
                    setInitializing(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLogout = () => { auth.signOut(); setRole(null); };

            if (initializing) return <div className="min-h-screen bg-gray-50 flex items-center justify-center"><div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div></div>;
            
            if (!user || !role) return <Login setRole={setRole} />;

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-900">
                    <Header user={user} role={role} handleLogout={handleLogout} />
                    <main className="py-8">
                        {role === 'student' ? <StudentDashboard user={user} /> : <OwnerDashboard />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>